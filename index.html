<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* GİRİŞ EKRANI İÇİN EK STİL */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f13; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .google-btn {
            background: white; color: #333; border: none; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: 0.3s; box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .google-btn:hover { transform: scale(1.05); background: #f0f0f0; }
        
        /* Dashboard başlangıçta gizli */
        #dashboard-screen { display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#00ff88; font-family:'Rajdhani'; font-size:3rem; margin-bottom:10px;">MINING FARM</h1>
        <p style="color:#aaa; margin-bottom:30px;">Devam etmek için giriş yapın</p>
        
        <button onclick="loginWithGoogle()" class="google-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="25">
            Google İle Başla
        </button>
        <p id="login-status" style="color:#00ff88; margin-top:20px; font-size:0.9rem;"></p>
    </div>


    <div id="dashboard-screen">
        <div class="dashboard-hero">
            <div class="hero-content">
                <div class="balance-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>Toplam Kazılan BTC</h2>
                        <button onclick="logout()" style="background:none; border:1px solid #333; color:#666; cursor:pointer; padding:5px 10px; border-radius:5px; font-size:0.8rem;">Çıkış Yap</button>
                    </div>
                    <div class="balance-val"><span id="main-balance">0.00000000</span></div>
                </div>
                
                <div class="stats-row">
                    <div class="wallet-group">
                        <button id="btnWithdraw" class="connect-btn" style="background-color: #2e7d32; border-color: #2e7d32; color: #fff;" onclick="requestWithdraw()">
                            <i class="fa-solid fa-money-bill-transfer"></i> <span>Çekim Talep</span>
                        </button>
                        <button class="connect-btn btn-ton"><i class="fa-brands fa-telegram"></i> <span>TON</span></button>
                    </div>
                    <div class="mini-stat"><label>Aktif Cüzdan</label><div><span id="user-email" style="font-size:0.9rem; color:#00ff88;">...</span></div></div>
                </div>
            </div>
        </div>

        <div class="middle-section">
            <div class="chart-container">
                <div class="panel-header"><div class="panel-title">SİSTEM PERFORMANSI</div></div>
                <div style="height:200px; display:flex; align-items:center; justify-content:center; color:#555;">GRAFİK ALANI</div>
            </div>
            <div class="terminal-container">
                <div class="panel-header"><div class="panel-title">root@miner:~# system.log</div></div>
                <div class="terminal-logs" id="log-window" style="color:#00ff88; font-size:0.8rem; padding:10px;">
                    > Sistem başlatılıyor...<br>
                    > Sunucu bağlantısı kuruldu.<br>
                    > Madencilik aktif.
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script> <script>
        // --- BURAYA FIREBASE CONFIG KODUNU YAPIŞTIR ---
        const firebaseConfig = {
            apiKey: "SENIN_API_KEYIN_BURAYA",
            authDomain: "SENIN_PROJEN.firebaseapp.com",
            projectId: "SENIN_PROJEN",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        // Firebase'i Başlat
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;

        // 1. KULLANICI DURUMUNU DİNLE (Sayfa açılınca çalışır)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // --- GİRİŞ YAPILMIŞSA ---
                currentUser = user;
                document.getElementById("login-screen").style.display = "none"; // Girişi gizle
                document.getElementById("dashboard-screen").style.display = "block"; // Paneli aç
                document.getElementById("user-email").innerText = user.email;

                // Bakiyeyi Yükle ve Kaydetmeyi Başlat
                loadUserData(user);
            } else {
                // --- GİRİŞ YAPILMAMIŞSA ---
                document.getElementById("login-screen").style.display = "flex"; // Girişi göster
                document.getElementById("dashboard-screen").style.display = "none"; // Paneli gizle
            }
        });

        // 2. GOOGLE İLE GİRİŞ FONKSİYONU
        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            document.getElementById("login-status").innerText = "Pencere açılıyor...";
            
            auth.signInWithPopup(provider).catch((error) => {
                alert("Hata: " + error.message);
            });
        }

        // 3. KULLANICI VERİSİNİ ÇEKME VE YENİ KULLANICI OLUŞTURMA
        function loadUserData(user) {
            const userRef = db.collection('users').doc(user.uid);
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    // Kullanıcı zaten var, bakiyeyi al
                    let serverBal = doc.data().balance;
                    localStorage.setItem('mining_balance', serverBal);
                    updateDisplay(serverBal);
                } else {
                    // Yeni kullanıcı, veritabanına ekle
                    userRef.set({
                        email: user.email,
                        balance: 0.00000000,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        localStorage.setItem('mining_balance', 0);
                        updateDisplay(0);
                    });
                }
                // Otomatik kaydı başlat
                startMiningAndSaving();
            });
        }

        // 4. EKRANI GÜNCELLEME
        function updateDisplay(val) {
            document.getElementById("main-balance").innerText = val.toFixed(8);
        }

        // 5. MADENCİLİK (GÖRSEL) VE KAYIT (SUNUCU)
        function startMiningAndSaving() {
            // Görsel Artış (Saniyede bir)
            setInterval(() => {
                let current = parseFloat(localStorage.getItem('mining_balance')) || 0;
                let increase = 0.00000005; // Hız
                let newBal = current + increase;
                
                localStorage.setItem('mining_balance', newBal);
                updateDisplay(newBal);
            }, 1000);

            // Sunucu Kaydı (60 Saniyede bir)
            setInterval(() => {
                saveToServer();
            }, 60000);
        }

        function saveToServer() {
            if (currentUser) {
                let current = parseFloat(localStorage.getItem('mining_balance'));
                db.collection('users').doc(currentUser.uid).update({
                    balance: current
                }).then(() => console.log("Yedeklendi"));
            }
        }

        // 6. ÇEKİM SAYFASINA GİT
        function requestWithdraw() {
            // Gitmeden önce son kez kaydet
            saveToServer();
            // Biraz bekle sonra aç
            setTimeout(() => {
                 window.open("withdraw.html", "_blank");
            }, 500);
        }

        // 7. ÇIKIŞ YAP
        function logout() {
            auth.signOut().then(() => {
                location.reload(); // Sayfayı yenile
            });
        }
    </script>
</body>
</html>